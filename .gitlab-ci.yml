stages:
  - test
  - build
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Multi-platform build support
  DOCKER_BUILDKIT: 1
  BUILDX_PLATFORMS: "linux/amd64,linux/arm64"

# Helm Chart Testing
helm-test:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bash openssl git
    - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - helm plugin install https://github.com/helm-unittest/helm-unittest --version=v0.3.3
  script:
    - echo "Running Helm unit tests..."
    - cd helm/yt-playlist
    - helm unittest . --with-subchart=false
    - echo "Validating Helm template rendering..."
    - helm template . --name-template yt-playlist --namespace default --dry-run=client > /dev/null
    - echo "‚úì Helm template renders successfully"
    - echo "Running Helm lint..."
    - helm lint .
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Build main application Docker image
build-yt-playlist:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker context create builder
    - docker buildx create --use builder
    - docker buildx inspect --bootstrap
  script:
    - |
      # Determine tags based on ref
      TAGS=""
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        TAGS="--tag $CI_REGISTRY_IMAGE:latest"
        TAGS="$TAGS --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
      elif [ "$CI_COMMIT_TAG" != "" ]; then
        TAGS="--tag $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
        # Extract version parts (e.g., v1.2.3 -> 1, 1.2, 1.2.3)
        VERSION=${CI_COMMIT_TAG#v}
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f1-2)
        TAGS="$TAGS --tag $CI_REGISTRY_IMAGE:$VERSION"
        TAGS="$TAGS --tag $CI_REGISTRY_IMAGE:$MAJOR"
        TAGS="$TAGS --tag $CI_REGISTRY_IMAGE:$MINOR"
      else
        TAGS="--tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
      fi
    - echo "Building with tags:$TAGS"
    - |
      docker buildx build \
        --platform $BUILDX_PLATFORMS \
        --push \
        $TAGS \
        --cache-from type=registry,ref=$CI_REGISTRY_IMAGE:buildcache \
        --cache-to type=registry,ref=$CI_REGISTRY_IMAGE:buildcache,mode=max \
        .
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Build auth-ui Docker image
build-auth-ui:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker context create builder
    - docker buildx create --use builder
    - docker buildx inspect --bootstrap
  script:
    - |
      # Registry image name for auth-ui
      AUTH_UI_IMAGE="$CI_REGISTRY_IMAGE/auth-ui"
      
      # Determine tags based on ref
      TAGS=""
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        TAGS="--tag $AUTH_UI_IMAGE:latest"
        TAGS="$TAGS --tag $AUTH_UI_IMAGE:$CI_COMMIT_SHORT_SHA"
      elif [ "$CI_COMMIT_TAG" != "" ]; then
        TAGS="--tag $AUTH_UI_IMAGE:$CI_COMMIT_TAG"
        VERSION=${CI_COMMIT_TAG#v}
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f1-2)
        TAGS="$TAGS --tag $AUTH_UI_IMAGE:$VERSION"
        TAGS="$TAGS --tag $AUTH_UI_IMAGE:$MAJOR"
        TAGS="$TAGS --tag $AUTH_UI_IMAGE:$MINOR"
      else
        TAGS="--tag $AUTH_UI_IMAGE:$CI_COMMIT_REF_SLUG"
      fi
    - echo "Building auth-ui with tags:$TAGS"
    - |
      docker buildx build \
        --platform $BUILDX_PLATFORMS \
        --push \
        $TAGS \
        --cache-from type=registry,ref=$AUTH_UI_IMAGE:buildcache \
        --cache-to type=registry,ref=$AUTH_UI_IMAGE:buildcache,mode=max \
        --file auth-ui/Dockerfile \
        auth-ui/
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Helm chart release (GitLab Pages)
helm-release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl bash openssl
    - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - git config user.name "${GITLAB_USER_NAME}"
    - git config user.email "${GITLAB_USER_EMAIL}"
  script:
    - |
      echo "Packaging Helm chart..."
      cd helm
      helm package yt-playlist
      
      # Get chart version
      CHART_VERSION=$(grep '^version:' yt-playlist/Chart.yaml | awk '{print $2}')
      APP_VERSION=$(grep '^appVersion:' yt-playlist/Chart.yaml | awk '{print $2}' | tr -d '"')
      
      echo "Chart version: $CHART_VERSION"
      echo "App version: $APP_VERSION"
      
      # Create public directory for GitLab Pages
      mkdir -p ../public
      mv yt-playlist-${CHART_VERSION}.tgz ../public/
      
      # Generate or update index.yaml
      cd ../public
      if [ -f index.yaml ]; then
        helm repo index . --merge index.yaml --url "https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}"
      else
        helm repo index . --url "https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}"
      fi
      
      # Create index.html landing page
      cat > index.html <<'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>YouTube Playlist Manager - Helm Repository</title>
          <style>
              body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                  max-width: 800px;
                  margin: 0 auto;
                  padding: 2rem;
                  line-height: 1.6;
                  color: #333;
              }
              h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 0.5rem; }
              h2 { color: #34495e; margin-top: 2rem; }
              code {
                  background: #f4f4f4;
                  padding: 0.2rem 0.4rem;
                  border-radius: 3px;
                  font-family: 'Courier New', monospace;
              }
              pre {
                  background: #2c3e50;
                  color: #ecf0f1;
                  padding: 1rem;
                  border-radius: 5px;
                  overflow-x: auto;
              }
              pre code { background: none; color: inherit; }
              a { color: #3498db; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .note {
                  background: #e8f4f8;
                  border-left: 4px solid #3498db;
                  padding: 1rem;
                  margin: 1rem 0;
              }
          </style>
      </head>
      <body>
          <h1>üé• YouTube Playlist Manager - Helm Repository</h1>
          
          <p>This is a Helm chart repository for the YouTube Playlist Manager application - an automated video downloader with playlist management.</p>
          
          <h2>üì¶ Add Repository</h2>
          <pre><code>helm repo add yt-playlist https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}/
      helm repo update</code></pre>
          
          <h2>üöÄ Install Chart</h2>
          <pre><code>helm install yt-playlist yt-playlist/yt-playlist \
        --set playlists.todoPlaylistId=PLxxxx \
        --set playlists.donePlaylistId=PLyyyy \
        --set clientSecretJson='{"installed":{...}}'</code></pre>
          
          <h2>üîç Search Charts</h2>
          <pre><code>helm search repo yt-playlist</code></pre>
          
          <h2>üìö Documentation</h2>
          <ul>
              <li><a href="https://gitlab.com/l4r51/yt-playlist">GitLab Repository</a></li>
              <li><a href="https://github.com/L4R5/yt-playlist">GitHub Mirror</a></li>
              <li><a href="index.yaml">Helm Repository Index</a></li>
          </ul>
          
          <div class="note">
              <strong>Note:</strong> This repository is automatically synchronized with the GitHub Pages repository at <a href="https://l4r5.github.io/yt-playlist/">https://l4r5.github.io/yt-playlist/</a>
          </div>
          
          <p style="margin-top: 2rem; color: #7f8c8d; font-size: 0.9rem;">
              Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC") | Chart version: ${CHART_VERSION} | App version: ${APP_VERSION}
          </p>
      </body>
      </html>
      EOF
      
      echo "Helm chart packaged and indexed successfully"
      echo "Repository URL: https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}"
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - helm/**/*
    - if: '$CI_PIPELINE_SOURCE == "web"'

# GitLab Pages deployment (automatic from artifacts)
pages:
  stage: release
  needs:
    - job: helm-release
      artifacts: true
  script:
    - echo "Deploying Helm repository to GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - helm/**/*
    - if: '$CI_PIPELINE_SOURCE == "web"'
